# SolrCloud 入门

## 概述
* SolrCloud 旨在提供一个高可用性、容错性的环境，用于跨多个服务器分发索引内容和查询请求。
* 在这个系统中，数据被组织成多个片段，或者分片，可以托管在多台机器上，副本为可伸缩性和容错性提供了冗余，而 ZooKeeper 服务器帮助管理整个结构，这样索引和搜索请求都可以正确路由。

## 一些零散概念

- 分片和复制
  - 如何判断分片数量？
    - 文档总数： 横向扩展一般更划算且速度更快
    - 文档大小：文档特大，单个分片存储的文档越少。平衡并发
    - 要求的索引吞吐量：索引负载均衡
    - 查询复杂度： 并发查询，加快速度
    - 预期增长
  - 复制策略
    - 作用
      - 冗余备份
      - 提升查询能力
    - 将索引与搜索分离
      - 主节点做索引，提升索引吞吐
      - 复制节点做查询，减少重新索引的影响？ 这里是否可以在全量和增量时做？ 还是只能如现在一样多备份一份索引，全量时查老的，完成后再切换？ 还是备份节点继续支持，主来做全量？ 挂了怎么办？
      - 什么时候这么做？ 在集群中将索引和搜索分离到不同服务器中或需要增加美妙的查询数量，可以采用这种复制模式
    - 自动容错


- 重载内核
  - 可以不用重启就能更新一些配置，这个过程请求处理依旧用老的，但重载完成新的内核才会被应用
  - 但是部分配置只能重启后才生效，比如 dataDir参数和IndexWriter设置
- 重命名和置换内核
- 卸载和删除内核
- 切分和合并索引
  - 切分 SPLIT
    - 目标内核已经被创建
        >http://localhost:8993/solr/cores?action=SPLIT&core=oldCore&targetCore=newCore1&targetCore=newCore2&targetCore=newCore3
      - targetCore至少指定一个
      - 必须保证每个targetCore指定的目标内核都已经被创建，并且在solr服务器中处于活跃状态。
      - 如果所指定的目标内核中某个内核已经有文档了，这些文档会和被切分的新文档合并
    - 目标内核还没运行
        >http://localhost:8993/solr/cores?action=SPLIT&core=oldCore&path=/path/to/newCore1/data/&path=/path/to/newCore2/data/&path=/path/to/newCore3/data/
      - split操作后在提交Create操作，以激活新的solr内核。
      - 这种方式嘉定指定路径下的索引已经被卸载了，并且不接受任何更新，否则如果没被卸载且接受更新，则会导致索引冲突。
  - 合并 MERGEINDEXES
    - 合并跟切分一样，也根据要合并的内核是否已经加载分为两种方式
- 获取内核状态信息
  - 获取全部
    >http://localhost:8993/solr/admin/cores?action=STATUS
  - 指定内核
    >http://localhost:8993/solr/admin/cores?action=STATUS&core=coreName


## 倒排索引
文档相关度排名是信息检索有别于其他搜索类型的重要方面。 谷歌百度搜狗都是用的倒排索引， mapreduce就是谷歌为了构建Web规模的倒排索引才诞生的。

## solr 和 lucene
1. 用的是lucene的构建索引能力，但lucene缺少生成索引结构的简单配置方法，定义字段和分析字段都需要编写Java代码
   1. 而solr通过schema.xml配置文件，实现了简单的索引结构定义和字段表示及分析的方法。
2. solr还做了一些扩展：
   1. 复制字段：取得一个字段或者多个字段的原始文本内容，并将其赋予不同的字段。
   2. 动态字段： 允许将同一个字段类型赋予给多个不同的字段，而不需要在schema.xml中声明。
3. 配置区别：
   >q	这是Apache Solr的主要查询参数，文档根据它们与此参数中的术语的相似性进行评分。
   >fq	此参数表示Apache Solr的筛选器查询，将结果集限制为与此筛选器匹配的文档。


4. 为什么选择solr，需要考量的标准
   1. 架构师：稳定性、可扩展性（伸缩性）和容错性
      1. 稳定性：成熟技术，活跃社区，经验丰富的开发人员支持（Lucene团队兼职）
      2. 分片和复制，更加健壮和易于管理
      3. SolrCloud
         1. 集中配置
         2. 无单点故障的分布式索引
         3. 发送故障会自动转换新的分片代表leader
         4. 查询可以发送到集群的任何一个节点，触发跨所有分片的完整的分布式搜索，内置故障转移和敷在功能支持
   2. 系统管理员：是否适合现有的基础架构
      1. 基于Java，可以运行在任何操作系统
      2. 内置了Jetty，提供很不错的管理控制台：发送测试查询，检查服务网络，查看配置，掌握分片副本分布情况。
      3. 所有访问都要通过HTTP。支持HTTP缓存反向代理，还支持JMX，能挂载架空应用